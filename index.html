<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Finanzas en Pareja</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>

<header>
  <h1>Finanzas en Pareja - Adriana - Santiago</h1>
</header>

<button id="modoToggle">üåô Modo Oscuro</button>

<section class="card">
  <strong>Saldo total:</strong>
  <p id="saldoTexto">Cargando...</p>
</section>

<section class="card gasto-form">
  <select id="autor">
    <option value="Santiago">Santiago</option>
    <option value="Adriana">Adriana</option>
  </select>
  <input type="text" id="descripcion" placeholder="Descripci√≥n del gasto" />
  <input type="number" id="monto" placeholder="Monto" step="0.01" />
  <select id="tipo-division">
    <option value="total">Se debe el total</option>
    <option value="mitad">Mitad y mitad</option>
    <option value="porcentaje">Porcentaje</option>
  </select>
  <div class="row" id="porcentaje-fields" style="display: none">
    <div><input type="number" id="porcentaje-Santiago" placeholder="% Santiago" max="100" /></div>
    <div><input type="number" id="porcentaje-Adriana" placeholder="% Adriana" max="100" /></div>
  </div>
  <button onclick="agregarGasto()">Agregar gasto</button>
</section>

<section id="gastos-lista"></section>

<button id="btn-liquidar-todo" onclick="liquidarDeudas()">üí∞</button>

<script>
  let gastos = [];

  fetch('/gastos.json')
    .then(r => r.json())
    .then(data => {
      gastos = data.gastos || []; // extrae el array
      renderGastos();
    });


  document.getElementById("tipo-division").addEventListener("change", e => {
    document.getElementById("porcentaje-fields").style.display = e.target.value === "porcentaje" ? "flex" : "none";
  });

  function guardarGastos() {
    fetch('/.netlify/functions/guardarGasto', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(gastos)
    });
  }

  function agregarGasto() {

    const autor = document.getElementById("autor").value;
    const descripcion = document.getElementById("descripcion").value.trim();
    const monto = parseFloat(document.getElementById("monto").value);
    const tipo = document.getElementById("tipo-division").value;

    if (!descripcion || isNaN(monto) || monto <= 0) return alert("Complete todos los campos correctamente");

    let porcentajeSantiago = 50, porcentajeAdriana = 50;
    if (tipo === "porcentaje") {
      porcentajeSantiago = parseInt(document.getElementById("porcentaje-Santiago").value) || 0;
      porcentajeAdriana = parseInt(document.getElementById("porcentaje-Adriana").value) || 0;
      if (porcentajeSantiago + porcentajeAdriana !== 100) return alert("Los porcentajes deben sumar 100%");
    }

    const nuevoGasto = { id: Date.now(), autor, descripcion, monto, tipo, porcentajeSantiago, porcentajeAdriana };
    gastos.push(nuevoGasto);
    guardarGastoIndividual(nuevoGasto);

    renderGastos();
  }

  function eliminarGasto(id) {
    gastos = gastos.filter(g => g.id !== id);
    guardarGastos();
    renderGastos();
  }

function renderGastos() {
  const cont = document.getElementById("gastos-lista");
  cont.innerHTML = "";
  let deuda = 0;

  for (let gasto of gastos) {
    const div = document.createElement("div");
    div.className = "gasto-item";
    div.setAttribute("data-autor", gasto.autor);
    div.innerHTML = `
      <button class="btn-eliminar" onclick="eliminarGasto(${gasto.id})">&times;</button>
      <div class="desc">${gasto.descripcion} - $${gasto.monto.toFixed(2)}</div>
      <div class="meta">Agregado por ${gasto.autor}</div>
    `;
    cont.appendChild(div);

    if (gasto.tipo === "total") {
      deuda += gasto.autor === "Santiago" ? gasto.monto : -gasto.monto;
    } else if (gasto.tipo === "mitad") {
      const mitad = gasto.monto / 2;
      deuda += gasto.autor === "Santiago" ? mitad : -mitad;
    } else if (gasto.tipo === "porcentaje") {
      const montoSantiago = (gasto.porcentajeSantiago / 100) * gasto.monto;
      const montoAdriana = (gasto.porcentajeAdriana / 100) * gasto.monto;
      const deberAdriana = gasto.autor === "Santiago" ? montoAdriana : -montoSantiago;
      deuda += deberAdriana;
    }
  }

  let texto = "Saldo balanceado";
  if (deuda > 0.01) texto = `Adriana debe $${deuda.toFixed(2)} a Santiago`;
  else if (deuda < -0.01) texto = `Santiago debe $${Math.abs(deuda).toFixed(2)} a Adriana`;
  document.getElementById("saldoTexto").textContent = texto;
}


  function liquidarDeudas() {
    if (!confirm("¬øSeguro que deseas eliminar todos los gastos?")) return;
    gastos = [];
    guardarGastos();
    renderGastos();
  }
  
function guardarGastoIndividual(gasto) {
  fetch('/.netlify/functions/guardarGasto', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(gasto)
  }).then(r => r.json())
    .then(data => {
      if (!data.success) console.error("Error guardando gasto:", data.error);
    });
}


    // Modo oscuro toggle
  const toggle = document.getElementById("modoToggle");
  toggle.addEventListener("click", () => {
    document.body.classList.toggle("dark");
    toggle.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è Modo Claro" : "üåô Modo Oscuro";
  });
</script>
</body>
</html>
