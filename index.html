<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Finanzas en Pareja</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>

<header>
  <h1>Finanzas en Pareja - Adriana - Santiago</h1>
</header>

<button id="modoToggle">üåô Modo Oscuro</button>

<section class="card">
  <strong>Saldo total:</strong>
  <p id="saldoTexto">Cargando...</p>
</section>

<section class="card gasto-form">
  <select id="autor">
    <option value="Santiago">Santiago</option>
    <option value="Adriana">Adriana</option>
  </select>
  <input type="text" id="descripcion" placeholder="Descripci√≥n del gasto" />
  <input type="number" id="monto" placeholder="Monto" step="0.01" />
  <select id="tipo-division">
    <option value="total">Se debe el total</option>
    <option value="mitad">Mitad y mitad</option>
    <option value="porcentaje">Porcentaje</option>
  </select>
  <div class="row" id="porcentaje-fields" style="display: none">
    <div><input type="number" id="porcentaje-Santiago" placeholder="% Santiago" max="100" /></div>
    <div><input type="number" id="porcentaje-Adriana" placeholder="% Adriana" max="100" /></div>
  </div>
  <button onclick="agregarGasto()">Agregar gasto</button>
</section>

<section id="gastos-lista"></section>

<button id="btn-liquidar-todo" onclick="liquidarDeudas()">üí∞</button>
<a href="liquidaciones.html">
  <button>üìä Ver Liquidaciones</button>
</a>

<script>
  let gastos = [];
  let liquidaciones = [];

  fetch('/gastos.json')
    .then(r => r.json())
    .then(data => {
      gastos = data.gastos || []; // extrae el array
      renderGastos();
    });


  document.getElementById("tipo-division").addEventListener("change", e => {
    document.getElementById("porcentaje-fields").style.display = e.target.value === "porcentaje" ? "flex" : "none";
  });

 async function guardarGastos() {
   await fetch('/.netlify/functions/guardarGasto', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(gastos)
    });
  }

  function agregarGasto() {

    const autor = document.getElementById("autor").value;
    const descripcion = document.getElementById("descripcion").value.trim();
    const monto = parseFloat(document.getElementById("monto").value);
    const tipo = document.getElementById("tipo-division").value;
    const fecha = new Date().toISOString().split("T")[0]; // formato YYYY-MM-DD
    const categoria = categorizarDescripcion(descripcion);

    if (!descripcion || isNaN(monto) || monto <= 0) return alert("Complete todos los campos correctamente");

    let porcentajeSantiago = 50, porcentajeAdriana = 50;
    if (tipo === "porcentaje") {
      porcentajeSantiago = parseInt(document.getElementById("porcentaje-Santiago").value) || 0;
      porcentajeAdriana = parseInt(document.getElementById("porcentaje-Adriana").value) || 0;
      if (porcentajeSantiago + porcentajeAdriana !== 100) return alert("Los porcentajes deben sumar 100%");
    }

    const nuevoGasto = {
      id: Date.now(),
      autor,
      descripcion,
      monto,
      tipo,
      porcentajeSantiago,
      porcentajeAdriana,
      fecha,
      categoria
    };
    gastos.push(nuevoGasto);
    guardarGastoIndividual(nuevoGasto);
    const mensaje = `üîî Se ha agregado un nuevo gasto:\n\nDescripci√≥n: "${descripcion}"\nMonto: $${monto}\nAgregado por ${autor}\nFecha: ${fecha}\n\nRev√≠salo aqu√≠: https://finanzaspareja.netlify.app`;
    enviarWhatsapp(mensaje);

    renderGastos();
  }

  function categorizarDescripcion(desc) {
  const mapa = {
    Comida: ["almuerzo", "cena", "comida", "hamburguesa", "restaurante", "taco"],
    Transporte: ["uber", "taxi", "bus", "pasaje", "metro", "transporte"],
    Servicios: ["agua", "luz", "gas", "internet", "tel√©fono"],
    Hogar: ["arriendo", "mercado", "supermercado", "limpieza"],
    Entretenimiento: ["cine", "netflix", "spotify", "juego", "fiesta"],
    Salud: ["medicina", "doctor", "salud", "farmacia"],
    Otros: []
  };

  const descLower = desc.toLowerCase();
  for (const [categoria, palabras] of Object.entries(mapa)) {
    if (palabras.some(p => descLower.includes(p))) return categoria;
  }
  return "Otros";
}

function confirmarEliminarGasto(id) {
  if (confirm("¬øEst√°s seguro de que deseas eliminar este gasto?")) {
    eliminarGasto(id);
  }
}



  function eliminarGasto(id) {
    gastos = gastos.filter(g => g.id !== id);
    guardarGastos();
    renderGastos();
  }

function renderGastos() {
  const cont = document.getElementById("gastos-lista");
  cont.innerHTML = "";
  let deuda = 0;

  for (let gasto of gastos) {
    const div = document.createElement("div");
    div.className = "gasto-item";
    div.setAttribute("data-autor", gasto.autor);
    let detalle = '';
    if (gasto.tipo === "total") {
      if (gasto.autor === "Santiago") {
        detalle = `Adriana debe a Santiago: $${gasto.monto}`;
      } else {
        detalle = `Santiago debe a Adriana: $${gasto.monto}`;
      }
    } else if (gasto.tipo === "mitad") {
      const mitad = gasto.monto / 2;
      detalle = `${gasto.autor} pag√≥ $${gasto.monto}, ${gasto.autor === "Santiago" ? "Adriana" : "Santiago"} debe $${mitad}`;
    } else {
      const s = (gasto.porcentajeSantiago / 100) * gasto.monto;
      const a = (gasto.porcentajeAdriana / 100) * gasto.monto;
      const debe = gasto.autor === "Santiago" ? a : s;
      detalle = `${gasto.autor} pag√≥ $${gasto.monto}, ${gasto.autor === "Santiago" ? "Adriana" : "Santiago"} debe $${debe}`;
    }

    div.innerHTML = `
      <button class="btn-eliminar" onclick="confirmarEliminarGasto(${gasto.id})">&times;</button>
      <button class="btn-liquidar" onclick="liquidarGasto(${gasto.id})">üí∞</button>
      <div class="desc">${detalle}</div>
      <div class="meta">${gasto.fecha}</div>
    `;
    cont.appendChild(div);

    if (gasto.tipo === "total") {
      deuda += gasto.autor === "Santiago" ? gasto.monto : -gasto.monto;
    } else if (gasto.tipo === "mitad") {
      const mitad = gasto.monto / 2;
      deuda += gasto.autor === "Santiago" ? mitad : -mitad;
    } else if (gasto.tipo === "porcentaje") {
      const montoSantiago = (gasto.porcentajeSantiago / 100) * gasto.monto;
      const montoAdriana = (gasto.porcentajeAdriana / 100) * gasto.monto;
      const deberAdriana = gasto.autor === "Santiago" ? montoAdriana : -montoSantiago;
      deuda += deberAdriana;
    }
  }

  let texto = "Saldo balanceado";
  if (deuda > 0.01) texto = `Adriana debe $${deuda.toFixed(2)} a Santiago`;
  else if (deuda < -0.01) texto = `Santiago debe $${Math.abs(deuda)} a Adriana`;
  document.getElementById("saldoTexto").textContent = texto;
}

async function liquidarGasto(id) {
  if (!confirm("¬øSeguro que deseas liquidar este gasto?")) return;

  const gasto = gastos.find(g => g.id === id);
  if (!gasto) return alert("Gasto no encontrado");

  // Fecha actual para la liquidaci√≥n
  const fechaLiquidacion = new Date().toISOString().split("T")[0];

  // Agregar gasto a liquidaciones
  liquidaciones.push({
    fecha: fechaLiquidacion,
    gastos: [gasto]
  });

  // Guardar liquidaciones
  await fetch('/.netlify/functions/guardarLiquidaciones', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(liquidaciones)
  });

  // Enviar notificaci√≥n WhatsApp
  const mensaje = `üîî Se ha liquidado un gasto:\n\nDescripci√≥n: "${gasto.descripcion}"\nMonto: $${gasto.monto}\nAgregado por ${gasto.autor}\nFecha: ${gasto.fecha}\n\nRev√≠salo aqu√≠: https://finanzaspareja.netlify.app`;
  enviarWhatsapp(mensaje);

  // Eliminar gasto de lista y guardar
  gastos = gastos.filter(g => g.id !== id);
  await guardarGastos();

  renderGastos();
}



async function liquidarDeudas() {
  if (!confirm("¬øSeguro que deseas eliminar todos los gastos?")) return;

  const fechaLiquidacion = new Date().toISOString().split("T")[0];
  const lote = {
    fecha: fechaLiquidacion,
    gastos: [...gastos]
  };
  liquidaciones.push(lote);

  await fetch('/.netlify/functions/guardarLiquidaciones', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(liquidaciones)
  });

 const detalle = gastos.map(g => `- ${g.descripcion} ($${g.monto})`).join("\n");
  enviarWhatsapp(`üîî Se ha generado una liquidaci√≥n:\n\n${detalle}`);


  gastos = [];
  guardarGastos();
  renderGastos();
}

async function verLiquidaciones() {
  const res = await fetch("/liquidaciones.json");
  const data = await res.json();
  liquidaciones = data;

  const mes = prompt("Filtrar por mes (formato YYYY-MM, ejemplo 2025-06):");

  const resultados = liquidaciones.flatMap(lote => {
    return lote.gastos
      .filter(g => g.fecha.startsWith(mes))
      .map(g => `${g.fecha} - ${g.descripcion} ($${g.monto}) [${g.categoria}]`);
  });

  alert("üìÖ Resultados:\n\n" + resultados.join("\n"));
}


 function guardarGastoIndividual(gasto) {
  fetch('/.netlify/functions/guardarGasto', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(gasto)
  }).then(r => r.json())
    .then(data => {
      if (!data.success) console.error("Error guardando gasto:", data.error);
    });
}

function enviarWhatsapp(mensaje) {
  const numeros = ["573219779439", "573157862008"];
  numeros.forEach(num => {
    fetch("/.netlify/functions/enviarWhatsapp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ number: num, text: mensaje })
    });
  });
}


    // Modo oscuro toggle
  const toggle = document.getElementById("modoToggle");
  toggle.addEventListener("click", () => {
    document.body.classList.toggle("dark");
    toggle.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è Modo Claro" : "üåô Modo Oscuro";
  });

  document.body.classList.add("dark");
</script>
</body>
</html>
